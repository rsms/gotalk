{"version":3,"file":"gotalk.js","sources":[".gotalk-debug.js"],"names":["global","__main","__mainapi","__mod","__api","evalDepth","require","name","m","id","replace","prefix","i","f","exports","module","EventEmitter","prototype","addListener","type","listener","TypeError","this","__events","Object","defineProperty","value","enumerable","writable","listeners","undefined","push","on","once","fired","trigger_event_once","removeListener","apply","arguments","p","indexOf","splice","length","removeAllListeners","emit","L","args","Array","slice","call","console","log","mixin","obj","proto","__proto__","Buf","Uint8Array","utf8","toString","encoding","start","end","decode","subarray","copy","targetBuffer","targetStart","sourceStart","sourceEnd","srcBuf","set","v","ArrayBuffer","isBuf","fromString","s","encode","netAccess","protocol","keepalive","addr","minReconnectDelay","maxReconnectDelay","ctx","open","retry","openTimer","opentime","delay","isEnabled","isConnected","enable","enabled","disable","clearTimeout","err","Date","available","onLine","document","location","hostname","isGotalkProtocolError","code","ErrorTimeout","Math","min","max","setTimeout","addEventListener","create","navigator","copyBufFixnum","b","n","digits","c","y","z","isNaN","charCodeAt","makeBufFixnum","makeStrFixnum","zeroes","substr","Version","MsgTypeSingleReq","MsgTypeStreamReq","MsgTypeRetryRes","MsgTypeStreamReqPart","MsgTypeSingleRes","MsgTypeStreamRes","MsgTypeErrorRes","MsgTypeNotification","MsgTypeHeartbeat","MsgTypeProtocolError","ErrorAbnormal","ErrorUnsupported","ErrorInvalidMsg","HeartbeatMsgMaxLoad","binary","makeFixnum","versionBuf","parseVersion","parseInt","parseMsg","t","namez","wait","size","makeMsg","nameb","makeHeartbeatMsg","load","round","getTime","text","buf","substring","String","fromCharCode","sizeOf","mask8","TextDecoder","decoder","encoder","TextEncoder","lead","e","j","decodeJSON","JSON","parse","Sock","handlers","heartbeatInterval","ws","nextOpID","nextStreamID","pendingRes","hasPendingRes","get","k","pendingClose","resetSock","causedByErr","stopSendingHeartbeats","onmessage","onerror","onclose","Error","handleRes","msg","payload","callback","Handlers","reqHandlers","reqFallbackHandler","noteHandlers","noteFallbackHandler","openWebSocket","WebSocket","binaryType","onopen","adoptWebSocket","handshake","startReading","ev","_bufferedMessages","data","txt","bin","gotalk","websocketCloseStatus",1000,1001,1002,1003,1005,1006,1007,1008,1009,"readyState","OPEN","_gotalkCloseError","adopt","rwc","send","close","address","url","ErrAbnormal","ErrUnsupported","ErrInvalidMsg","ErrTimeout","sendHeartbeat","startSendingHeartbeats","_sendHeartbeatsTimer","readMsg","errcode","readMsgPayload","handleMsg","readVersion","peerVersion","closeError","forEach","msgHandlers","msgHandler","handler","result","findRequestHandler","outbuf","sendMsg","error","errstr","message","stack","findNotificationHandler","time","payloadSize","bufferRequest","op","bufferNotify","request","stringify","notify","StreamRequest","write","ended","started","streamRequest","req","handleBufferRequest","handleRequest","resultWrapper","handleBufferNotification","handleNotification","gotalkResponderAt","at","defaultResponderAddress","host","onConnect","defaultHandlers","openKeepAlive","connection","handle"],"mappings":"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","sourcesContent":["(function(global){\n\"use strict\";\n\nvar __mod = {}, __api = {}, __main, __mainapi;\nvar evalDepth = 0;\n\nvar require = function(name) {\n  var m, id = name.replace(/^.\\//, \"\");\n  m = __api[id];\n  //console.log('require', {name:name, id:id, exports:m});\n  if (!m) {\n    var prefix = ''; for (var i = 0; i < evalDepth; i++) {\n      prefix += '. ';\n    }\n    var f = __mod[id];\n    if (f && evalDepth < 100) {\n      __mod[id] = null;\n      __api[id] = {exports:{}};\n      ++evalDepth;\n      f(__api[id]);\n      --evalDepth;\n      __api[id] = __api[id].exports;\n    }\n    m = __api[id];\n  }\n  return m;\n};\n\n__mod[\"EventEmitter\"]=function(module) { var exports = module.exports;\n\nfunction EventEmitter() {}\nmodule.exports = EventEmitter;\n\nEventEmitter.prototype.addListener = function (type, listener) {\n  if (typeof listener !== 'function') throw TypeError('listener must be a function');\n  if (!this.__events) {\n    Object.defineProperty(this, '__events', {value:{}, enumerable:false, writable:true});\n    this.__events[type] = [listener];\n    return this;\n  }\n  var listeners = this.__events[type];\n  if (listeners === undefined) {\n    this.__events[type] = [listener];\n    return this;\n  }\n  listeners.push(listener);\n  return this;\n};\n\nEventEmitter.prototype.on = EventEmitter.prototype.addListener;\n\nEventEmitter.prototype.once = function (type, listener) {\n  var fired = false;\n  var trigger_event_once = function() {\n    this.removeListener(type, trigger_event_once);\n    if (!fired) {\n      fired = true;\n      listener.apply(this, arguments);\n    }\n  }\n  return this.on(type, trigger_event_once);\n};\n\nEventEmitter.prototype.removeListener = function (type, listener) {\n  var p, listeners = this.__events ? this.__events[type] : undefined;\n  if (listeners !== undefined) {\n    while ((p = listeners.indexOf(listener)) !== -1) {\n      listeners.splice(p,1);\n    }\n    if (listeners.length === 0) {\n      delete this.__events[type];\n    }\n    return listeners.length;\n  }\n  return this;\n};\n\nEventEmitter.prototype.removeAllListeners = function (type) {\n  if (this.__events) {\n    if (type) {\n      delete this.__events[type];\n    } else {\n      delete this.__events;\n    }\n  }\n};\n\nEventEmitter.prototype.listeners = function (type) {\n  return type ? (this.__events ? this.__events[type] : undefined) : this.__events;\n};\n\nEventEmitter.prototype.emit = function (type) {\n  var listeners = this.__events ? this.__events[type] : undefined;\n  if (listeners === undefined) {\n    return false;\n  }\n  var i = 0, L = listeners.length, args = Array.prototype.slice.call(arguments,1);\n  for (; i !== L; ++i) {\n    if (!listeners[i]) {\n      console.log('e', type, i, args);\n    }\n    listeners[i].apply(this, args);\n  }\n  return true;\n};\n\nEventEmitter.mixin = function mixin(obj) {\n  var proto = obj;\n  while (proto) {\n    if (proto.__proto__ === Object.prototype) {\n      proto.__proto__ = EventEmitter.prototype;\n      return obj;\n    }\n    proto = proto.__proto__;\n  }\n  return obj;\n};\n\n\n};\n\n__mod[\"buf\"]=function(module) { var exports = module.exports;\n\"use strict\";\nvar Buf;\n\nif (typeof Uint8Array !== 'undefined') {\n\nvar utf8 = require('./utf8');\n\nUint8Array.prototype.toString = function (encoding, start, end) {\n  // assumes buffer contains UTF8-encoded text\n  return utf8.decode(this, start, end);\n};\n\nUint8Array.prototype.slice = Uint8Array.prototype.subarray;\n\n// Copies data from a region of this buffer to a region in the target buffer.\n// copy(targetBuffer, [targetStart], [sourceStart], [sourceEnd]) -> Buf\nUint8Array.prototype.copy = function (targetBuffer, targetStart, sourceStart, sourceEnd) {\n  var srcBuf = this;\n  if (sourceStart) {\n    srcBuf = srcBuf.slice(sourceStart, sourceEnd || srcBuf.length - sourceStart);\n  }\n  targetBuffer.set(srcBuf, targetStart || 0);\n};\n\n\n// Buf(Buf) -> Buf\n// Buf(size int) -> Buf\n// Buf(ArrayBuffer) -> Buf\nBuf = function Buf(v) {\n  return v instanceof Uint8Array ? v :\n    new Uint8Array(\n      v instanceof ArrayBuffer ? v :\n      new ArrayBuffer(v)\n    );\n};\n\nBuf.isBuf = function (v) {\n  return v instanceof Uint8Array;\n};\n\nBuf.fromString = function (s, encoding) {\n  return utf8.encode(s, Buf);\n};\n\n}\n\nmodule.exports = Buf;\n\n};\n\n__mod[\"keepalive\"]=function(module) { var exports = module.exports;\n\"use strict\";\n// Stay connected by automatically reconnecting w/ exponential back-off.\n\nvar netAccess = require('./netaccess');\nvar protocol = require('./protocol');\n\n// `s` must conform to interface { connect(addr string, cb function(Error)) }\n// Returns an object {\n//   isConnected bool  // true if currently connected\n//   isEnabled bool    // true if enabled\n//   enable()          // enables staying connected\n//   disable()         // disables trying to stay connected\n// }\nvar keepalive = function(s, addr, minReconnectDelay, maxReconnectDelay) {\n  if (!minReconnectDelay) {\n    minReconnectDelay = 500;\n  } else if (minReconnectDelay < 100) {\n    minReconnectDelay = 100;\n  }\n\n  if (!maxReconnectDelay || maxReconnectDelay < minReconnectDelay) {\n    maxReconnectDelay = 5000;\n  }\n\n  var ctx, open, retry, delay = 0, openTimer, opentime;\n\n  ctx = {\n    isEnabled: false,\n    isConnected: false,\n    enable: function() {\n      if (!ctx.enabled) {\n        ctx.enabled = true;\n        delay = 0;\n        if (!ctx.isConnected) {\n          open();\n        }\n      }\n    },\n    disable: function() {\n      if (ctx.enabled) {\n        clearTimeout(openTimer);\n        ctx.enabled = false;\n        delay = 0;\n      }\n    }\n  };\n\n  open = function() {\n    clearTimeout(openTimer);\n    s.open(addr, function(err) {\n      opentime = new Date;\n      if (err) {\n        retry(err);\n      } else {\n        delay = 0;\n        ctx.isConnected = true;\n        s.once('close', retry);\n      }\n    });\n  };\n\n  retry = function(err) {\n    clearTimeout(openTimer);\n    ctx.isConnected = false;\n    if (!ctx.enabled) {\n      return;\n    }\n    if (netAccess.available && !netAccess.onLine && \n        !(typeof document !== 'undefined' &&\n          document.location &&\n          document.location.hostname !== 'localhost' &&\n          document.location.hostname !== '127.0.0.1' &&\n          document.location.hostname !== '[::1]') )\n    {\n      netAccess.once('online', retry);\n      delay = 0;\n      return;\n    }\n    if (err) {\n      if (err.isGotalkProtocolError) {\n        if (err.code === protocol.ErrorTimeout) {\n          delay = 0;\n        } else {\n          // We shouldn't retry with the same version of our gotalk library.\n          // However, the only sensible thing to do in this case is to let the user code react to\n          // the error passed to the close event (e.g. to show a \"can't talk to server\" UI), and\n          // retry in maxReconnectDelay.\n          // User code can choose to call `disable()` on its keepalive object in this case.\n          delay = maxReconnectDelay;\n        }\n      } else {\n        // increase back off in case of an error\n        delay = delay ? Math.min(maxReconnectDelay, delay * 2) : minReconnectDelay;\n      }\n    } else {\n      delay = Math.max(0, minReconnectDelay - ((new Date) - opentime));\n    }\n    openTimer = setTimeout(open, delay);\n  };\n\n  return ctx;\n};\n\nmodule.exports = keepalive;\n\n};\n\n__mod[\"netaccess\"]=function(module) { var exports = module.exports;\n\"use strict\";\nvar EventEmitter = require('./EventEmitter');\nvar m;\n\nif (typeof global !== 'undefined' && global.addEventListener) {\n  m = Object.create(EventEmitter.prototype, {\n    available: {value:true, enumerable:true},\n    onLine:    {value:true, enumerable:true, writable:true}\n  });\n\n  if (typeof navigator !== 'undefined') {\n    m.onLine = navigator.onLine;\n  }\n\n  global.addEventListener(\"offline\", function (ev) {\n    m.onLine = false;\n    m.emit('offline');\n  });\n\n  global.addEventListener(\"online\", function (ev) {\n    m.onLine = true;\n    m.emit('online');\n  });\n\n} else {\n  m = {available:false, onLine:true};\n}\n\nmodule.exports = m;\n\n};\n\n__mod[\"protocol\"]=function(module) { var exports = module.exports;\n\"use strict\";\nvar Buf = require('./buf');\nvar utf8 = require('./utf8');\n\n// Version of this protocol\nexports.Version = 1;\n\n// Message types\nvar MsgTypeSingleReq     = exports.MsgTypeSingleReq =     'r'.charCodeAt(0),\n    MsgTypeStreamReq     = exports.MsgTypeStreamReq =     's'.charCodeAt(0),\n    MsgTypeStreamReqPart = exports.MsgTypeStreamReqPart = 'p'.charCodeAt(0),\n    MsgTypeSingleRes     = exports.MsgTypeSingleRes =     'R'.charCodeAt(0),\n    MsgTypeStreamRes     = exports.MsgTypeStreamRes =     'S'.charCodeAt(0),\n    MsgTypeErrorRes      = exports.MsgTypeErrorRes =      'E'.charCodeAt(0),\n    MsgTypeRetryRes      = exports.MsgTypeRetryRes =      'e'.charCodeAt(0),\n    MsgTypeNotification  = exports.MsgTypeNotification =  'n'.charCodeAt(0),\n    MsgTypeHeartbeat     = exports.MsgTypeHeartbeat =     'h'.charCodeAt(0),\n    MsgTypeProtocolError = exports.MsgTypeProtocolError = 'f'.charCodeAt(0);\n\n// ProtocolError codes\nexports.ErrorAbnormal    = 0\nexports.ErrorUnsupported = 1;\nexports.ErrorInvalidMsg  = 2;\nexports.ErrorTimeout     = 3;\n\n// Maximum value of a heartbeat's \"load\"\nexports.HeartbeatMsgMaxLoad = 0xffff;\n\n// ==============================================================================================\n// Binary (byte) protocol\n\nfunction copyBufFixnum(b, start, n, digits) {\n  var i = start || 0, y = 0, c, s = n.toString(16), z = digits - s.length;\n  for (; z--;) { b[i++] = 48; }\n  for (; !isNaN(c = s.charCodeAt(y++));) { b[i++] = c; }\n}\n\nfunction makeBufFixnum(n, digits) {\n  var b = Buf(digits);\n  copyBufFixnum(b, 0, n, digits);\n  return b;\n}\n\n// Note: This code assumes parseInt accepts a Buf\n\nexports.binary = {\n\n  makeFixnum: makeBufFixnum,\n\n  versionBuf: makeBufFixnum(exports.Version, 2),\n\n  parseVersion: function (b) {\n    return parseInt(b, 16);\n  },\n\n  // Parses a byte buffer containing a message (not including payload data.)\n  // If t is MsgTypeHeartbeat, wait==load, size==time.\n  // -> {t:string, id:Buf, name:string, wait:int size:int} | null\n  parseMsg: function (b) {\n    var t, id, name, namez, wait = 0, size = 0, z;\n\n    t = b[0];\n    z = 1;\n\n    if (t === MsgTypeHeartbeat) {\n      wait = parseInt(b.slice(z, z + 4), 16);\n      z += 4;\n    } else if (t !== MsgTypeNotification && t !== MsgTypeProtocolError) {\n      id = b.slice(z, z + 4);\n      z += 4;\n    }\n\n    if (t == MsgTypeSingleReq || t == MsgTypeStreamReq || t == MsgTypeNotification) {\n      namez = parseInt(b.slice(z, z + 3), 16);\n      z += 3;\n      name = b.slice(z, z+namez).toString();\n      z += namez;\n    } else if (t === MsgTypeRetryRes) {\n      wait = parseInt(b.slice(z, z + 8), 16);\n      z += 8\n    }\n\n    size = parseInt(b.slice(z, z + 8), 16);\n\n    return {t:t, id:id, name:name, wait:wait, size:size};\n  },\n\n  // Create a buf representing a message (w/o any payload)\n  makeMsg: function (t, id, name, wait, size) {\n    var b, nameb, z = id ? 13 : 9;\n\n    if (name && name.length !== 0) {\n      nameb = Buf.fromString(name);\n      z += 3 + nameb.length;\n    }\n\n    b = Buf(z);\n\n    b[0] = t;\n    z = 1;\n\n    if (id && id.length === 4) {\n      if (typeof id === 'string') {\n        b[1] = id.charCodeAt(0);\n        b[2] = id.charCodeAt(1);\n        b[3] = id.charCodeAt(2);\n        b[4] = id.charCodeAt(3);\n      } else {\n        b[1] = id[0];\n        b[2] = id[1];\n        b[3] = id[2];\n        b[4] = id[3];\n      }\n      z += 4;\n    }\n\n    if (name && name.length !== 0) {\n      nameb = Buf.fromString(name);\n      copyBufFixnum(b, z, nameb.length, 3);\n      z += 3;\n      nameb.copy(b, z);\n      z += nameb.length;\n    }\n\n    if (t === MsgTypeRetryRes) {\n      copyBufFixnum(b, z, wait, 8);\n      z += 8\n    }\n\n    copyBufFixnum(b, z, size, 8);\n\n    return b;\n  },\n\n  // Create a buf representing a heartbeat message\n  makeHeartbeatMsg: function(load) {\n    var b = Buf(13), z = 1;\n    b[0] = MsgTypeHeartbeat;\n    copyBufFixnum(b, z, load, 4);\n    z += 4;\n    copyBufFixnum(b, z, Math.round((new Date).getTime()/1000), 8);\n    z += 8;\n    return b;\n  }\n};\n\n\n// ==============================================================================================\n// Text protocol\n\nvar zeroes = '00000000';\n\nfunction makeStrFixnum(n, digits) {\n  var s = n.toString(16);\n  return zeroes.substr(0, digits - s.length) + s;\n}\n\nexports.text = {\n\n  makeFixnum: makeStrFixnum,\n\n  versionBuf: makeStrFixnum(exports.Version, 2),\n\n  parseVersion: function (buf) {\n    return parseInt(buf.substr(0,2), 16);\n  },\n\n  // Parses a text string containing a message (not including payload data.)\n  // If t is MsgTypeHeartbeat, wait==load, size==time.\n  // -> {t:string, id:Buf, name:string, wait:int size:int} | null\n  parseMsg: function (s) {\n    // \"r001004echo00000005\" => ('r', \"001\", \"echo\", 5)\n    // \"R00100000005\"        => ('R', \"001\", \"\", 5)\n    var t, id, name, wait = 0, size = 0, z;\n\n    t = s.charCodeAt(0);\n    z = 1;\n\n    if (t === MsgTypeHeartbeat) {\n      wait = parseInt(s.substr(z, 4), 16);\n      z += 4;\n    } else if (t !== MsgTypeNotification && t !== MsgTypeProtocolError) {\n      id = s.substr(z, 4);\n      z += 4;\n    }\n\n    if (t == MsgTypeSingleReq || t == MsgTypeStreamReq || t == MsgTypeNotification) {\n      name = s.substring(z + 3, s.length - 8);\n    } else if (t == MsgTypeRetryRes) {\n      wait = parseInt(s.substr(z, 8), 16);\n      z += 8\n    }\n\n    size = parseInt(s.substr(s.length - 8), 16);\n\n    return {t:t, id:id, name:name, wait:wait, size:size};\n  },\n\n\n  // Create a text string representing a message (w/o any payload.)\n  makeMsg: function (t, id, name, wait, size) {\n    var b = String.fromCharCode(t);\n\n    if (id && id.length === 4) {\n      b += id;\n    }\n\n    if (name && name.length !== 0) {\n      b += makeStrFixnum(utf8.sizeOf(name), 3);\n      b += name;\n    }\n\n    if (t === MsgTypeRetryRes) {\n      b += makeStrFixnum(wait, 8);\n    }\n\n    b += makeStrFixnum(size, 8);\n\n    return b;\n  },\n\n  // Create a text string representing a heartbeat message\n  makeHeartbeatMsg: function(load) {\n    var s = String.fromCharCode(MsgTypeHeartbeat);\n    s += makeStrFixnum(load, 4);\n    s += makeStrFixnum(Math.round((new Date).getTime()/1000), 8);\n    return s;\n  }\n\n}; // exports.text\n\n\n};\n\n__mod[\"utf8\"]=function(module) { var exports = module.exports;\n\"use strict\";\n//\n// decode(Buf, [start], [end]) -> String\n// encode(String, BufFactory) -> Buf\n// sizeOf(String) -> int\n//\n\n// Returns the number of bytes needed to represent string `s` as UTF8\nfunction sizeOf(s) {\n  var z = 0, i = 0, c;\n  for (; c = s.charCodeAt(i++); z += (c >> 11 ? 3 : c >> 7 ? 2 : 1) );\n  return z;\n}\nexports.sizeOf = sizeOf;\n\nfunction mask8(c) {\n  return 0xff & c;\n}\n\nif (typeof TextDecoder !== 'undefined') {\n  // ============================================================================================\n  // Native TextDecoder/TextEncoder implementation\n  var decoder = new TextDecoder('utf8');\n  var encoder = new TextEncoder('utf8');\n\n  exports.decode = function decode(b, start, end) {\n    if (start || end) {\n      if (!start) start = 0;\n      b = b.slice(start, end || b.length - start);\n    }\n    return decoder.decode(b);\n  };\n\n  exports.encode = function encode(s, Buf) {\n    return Buf(encoder.encode(s));\n  };\n\n} else {\n  // ============================================================================================\n  // JS implementation\n\n  exports.decode = function decode(b, start, end) {\n    var i = start || 0, e = (end || b.length - i), c, lead, s = '';\n    for (i = 0; i < e; ) {\n      c = b[i++];\n      lead = mask8(c);\n      if (lead < 0x80) {\n        // single byte\n      } else if ((lead >> 5) == 0x6) {\n        c = ((c << 6) & 0x7ff) + (b[i++] & 0x3f);\n      } else if ((lead >> 4) == 0xe) {\n        c = ((c << 12) & 0xffff) + ((mask8(b[i++]) << 6) & 0xfff);\n        c += b[i++] & 0x3f;\n      } else if ((lead >> 3) == 0x1e) {\n        c = ((c << 18) & 0x1fffff) + ((mask8(b[i++]) << 12) & 0x3ffff);\n        c += (mask8(b[i++]) << 6) & 0xfff;\n        c += b[i++] & 0x3f;\n      }\n      s += String.fromCharCode(c);\n    }\n\n    return s;\n  };\n\n  exports.encode = function encode(s, Buf) {\n    var i = 0, e = s.length, c, j = 0, b = Buf(sizeOf(s));\n    for (; i !== e;) {\n      c = s.charCodeAt(i++);\n      // TODO FIXME: charCodeAt returns UTF16-like codepoints, not UTF32 codepoints, meaning that\n      // this code only works for BMP. However, current ES only supports BMP. Ultimately we should\n      // dequeue a second UTF16 codepoint when c>BMP.\n      if (c < 0x80) {\n        b[j++] = c;\n      } else if (c < 0x800) {\n        b[j++] = (c >> 6)   | 0xc0;\n        b[j++] = (c & 0x3f) | 0x80;\n      } else if (c < 0x10000) {\n        b[j++] = (c >> 12)          | 0xe0;\n        b[j++] = ((c >> 6) & 0x3f)  | 0x80;\n        b[j++] = (c & 0x3f)         | 0x80;\n      } else {\n        b[j++] = (c >> 18)          | 0xf0;\n        b[j++] = ((c >> 12) & 0x3f) | 0x80;\n        b[j++] = ((c >> 6) & 0x3f)  | 0x80;\n        b[j++] = (c & 0x3f)         | 0x80;\n      }\n    }\n    return b;\n  };\n\n}\n\n// var s = '∆åßf'; // '日本語'\n// var b = exports.encode(s);\n// console.log('encode(\"'+s+'\") =>', b);\n// console.log('decode(',b,') =>', exports.decode(b));\n\n};\n\n__main=function(module) { var exports = module.exports;\n\"use strict\";\nvar protocol = require('./protocol'),\n      txt = protocol.text,\n      bin = protocol.binary;\nvar Buf = require('./buf');\nvar utf8 = require('./utf8');\nvar EventEmitter = require('./EventEmitter');\nvar keepalive = require('./keepalive');\n\nvar gotalk = exports;\n\ngotalk.protocol = protocol;\ngotalk.Buf = Buf;\n\nfunction decodeJSON(v) {\n  try { return JSON.parse(v); } catch (e) {}\n}\n\n\n// ===============================================================================================\n\nfunction Sock(handlers) { return Object.create(Sock.prototype, {\n  // Public properties\n  handlers:      {value:handlers, enumerable:true},\n  protocol:      {value: Buf ? protocol.binary : protocol.text, enumerable:true, writable:true},\n  heartbeatInterval: {value: 20 * 1000, enumerable:true, writable:true},\n\n  // Internal\n  ws:            {value:null, writable:true},\n  keepalive:     {value:null, writable:true},\n\n  // Used for performing requests\n  nextOpID:      {value:0, writable:true},\n  nextStreamID:  {value:0, writable:true},\n  pendingRes:    {value:{}, writable:true},\n  hasPendingRes: {get:function(){ for (var k in this.pendingRes) { return true; } }},\n\n  // True if end() has been called while there were outstanding responses\n  pendingClose:  {value:false, writable:true}\n}); }\n\nSock.prototype = EventEmitter.mixin(Sock.prototype);\nexports.Sock = Sock;\n\n\nfunction resetSock(s, causedByErr) {\n  s.pendingClose = false;\n  s.stopSendingHeartbeats();\n\n  if (s.ws) {\n    s.ws.onmessage = null;\n    s.ws.onerror = null;\n    s.ws.onclose = null;\n    s.ws = null;\n  }\n\n  s.nextOpID = 0;\n  if (s.hasPendingRes) {\n    var err = causedByErr || new Error('connection closed');\n    // TODO: return a RetryResult kind of error instead of just an error\n    for (var k in s.pendingRes) {\n      s.pendingRes[k](err);\n    }\n    s.pendingRes = {};\n  }\n}\n\n\nvar websocketCloseStatus = {\n  1000: 'normal',\n  1001: 'going away',\n  1002: 'protocol error',\n  1003: 'unsupported',\n  // 1004 is currently unassigned\n  1005: 'no status',\n  1006: 'abnormal',\n  1007: 'inconsistent',\n  1008: 'invalid message',\n  1009: 'too large',\n};\n\n\n// Adopt a web socket, which should be in an OPEN state\nSock.prototype.adoptWebSocket = function(ws) {\n  var s = this;\n  if (ws.readyState !== WebSocket.OPEN) {\n    throw new Error('web socket readyState != OPEN');\n  }\n  ws.binaryType = 'arraybuffer';\n  s.ws = ws;\n  ws.onclose = function(ev) {\n    var err = ws._gotalkCloseError;\n    if (!err && ev.code !== 1000) {\n      err = new Error('websocket closed: ' + (websocketCloseStatus[ev.code] || '#'+ev.code));\n    }\n    resetSock(s, err);\n    s.emit('close', err);\n  };\n  ws.onmessage = function(ev) {\n    if (!ws._bufferedMessages) ws._bufferedMessages = [];\n    ws._bufferedMessages.push(ev.data);\n  };\n};\n\n\nSock.prototype.adopt = function(rwc) {\n  if (adopt instanceof WebSocket) {\n    return this.adoptWebSocket(rwc);\n  } else {\n    throw new Error('unsupported transport');\n  }\n};\n\n\nSock.prototype.handshake = function () {\n  this.ws.send(this.protocol.versionBuf);\n};\n\n\nSock.prototype.end = function() {\n  // Allow calling twice to \"force close\" even when there are pending responses\n  var s = this;\n  if (s.keepalive) {\n    s.keepalive.disable();\n    s.keepalive = null;\n  }\n  if (!s.pendingClose && s.hasPendingRes) {\n    s.pendingClose = true;\n  } else if (s.ws) {\n    s.ws.close(1000);\n  }\n};\n\n\nSock.prototype.address = function() {\n  var s = this;\n  if (s.ws) {\n    return s.ws.url;\n  }\n  return null;\n};\n\n// ===============================================================================================\n// Reading messages from a connection\n\nvar ErrAbnormal = exports.ErrAbnormal = Error(\"unsupported protocol\");\nErrAbnormal.isGotalkProtocolError = true;\nErrAbnormal.code = protocol.ErrorAbnormal;\n\nvar ErrUnsupported = exports.ErrUnsupported = Error(\"unsupported protocol\");\nErrUnsupported.isGotalkProtocolError = true;\nErrUnsupported.code = protocol.ErrorUnsupported;\n\nvar ErrInvalidMsg = exports.ErrInvalidMsg = Error(\"invalid protocol message\");\nErrInvalidMsg.isGotalkProtocolError = true;\nErrInvalidMsg.code = protocol.ErrorInvalidMsg;\n\nvar ErrTimeout = exports.ErrTimeout = Error(\"timeout\");\nErrTimeout.isGotalkProtocolError = true;\nErrTimeout.code = protocol.ErrorTimeout;\n\n\nSock.prototype.sendHeartbeat = function (load) {\n  var s = this, buf = s.protocol.makeHeartbeatMsg(Math.round(load * protocol.HeartbeatMsgMaxLoad));\n  try {\n    s.ws.send(buf);\n  } catch (err) {\n    if (!this.ws || this.ws.readyState > WebSocket.OPEN) {\n      err = new Error('socket is closed');\n    }\n    throw err;\n  }\n};\n\n\nSock.prototype.startSendingHeartbeats = function() {\n  var s = this;\n  if (s.heartbeatInterval < 10) {\n    throw new Error(\"Sock.heartbeatInterval is too low\");\n  }\n  clearTimeout(s._sendHeartbeatsTimer);\n  var send = function() {\n    clearTimeout(s._sendHeartbeatsTimer);\n    s.sendHeartbeat(0);\n    s._sendHeartbeatsTimer = setTimeout(send, s.heartbeatInterval);\n  };\n  s._sendHeartbeatsTimer = setTimeout(send, 1);\n};\n\n\nSock.prototype.stopSendingHeartbeats = function() {\n  var s = this;\n  clearTimeout(s._sendHeartbeatsTimer);\n};\n\n\nSock.prototype.startReading = function () {\n  var s = this, ws = s.ws, msg;  // msg = current message\n\n  function readMsg(ev) {\n    msg = typeof ev.data === 'string' ? txt.parseMsg(ev.data) : bin.parseMsg(Buf(ev.data));\n    // console.log(\n    //   'readMsg:',\n    //   typeof ev.data === 'string' ? ev.data : Buf(ev.data).toString(),\n    //   'msg:',\n    //   msg\n    // );\n    if (msg.t === protocol.MsgTypeProtocolError) {\n      var errcode = msg.size;\n      if (errcode === protocol.ErrorAbnormal) {\n        ws._gotalkCloseError = ErrAbnormal;\n      } else if (errcode === protocol.ErrorUnsupported) {\n        ws._gotalkCloseError = ErrUnsupported;\n      } else if (errcode === protocol.ErrorTimeout) {\n        ws._gotalkCloseError = ErrTimeout;\n      } else {\n        ws._gotalkCloseError = ErrInvalidMsg;\n      }\n      ws.close(4000 + errcode);\n    } else if (msg.size !== 0 && msg.t !== protocol.MsgTypeHeartbeat) {\n      ws.onmessage = readMsgPayload;\n    } else {\n      s.handleMsg(msg);\n      msg = null;\n    }\n  }\n\n  function readMsgPayload(ev) {\n    var b = ev.data;\n    ws.onmessage = readMsg;\n    s.handleMsg(msg, typeof b === 'string' ? b : Buf(b));\n    msg = null;\n  }\n\n  function readVersion(ev) {\n    var peerVersion = typeof ev.data === 'string' ? txt.parseVersion(ev.data) :\n                                                    bin.parseVersion(Buf(ev.data));\n    if (peerVersion !== protocol.Version) {\n      ws._gotalkCloseError = ErrUnsupported;\n      s.closeError(protocol.ErrorUnsupported);\n    } else {\n      ws.onmessage = readMsg;\n      if (s.heartbeatInterval > 0) {\n        s.startSendingHeartbeats();\n      }\n    }\n  }\n\n  // We begin by sending our version and reading the remote side's version\n  ws.onmessage = readVersion;\n\n  // Any buffered messages?\n  if (ws._bufferedMessages) {\n    ws._bufferedMessages.forEach(function(data){ ws.onmessage({data:data}); });\n    ws._bufferedMessages = null;\n  }\n};\n\n// ===============================================================================================\n// Handling of incoming messages\n\nvar msgHandlers = {};\n\nSock.prototype.handleMsg = function(msg, payload) {\n  // console.log('handleMsg:', String.fromCharCode(msg.t), msg, 'payload:', payload);\n  var s = this;\n  var msgHandler = msgHandlers[msg.t];\n  if (!msgHandler) {\n    if (s.ws) {\n      s.ws._gotalkCloseError = ErrInvalidMsg;\n    }\n    s.closeError(protocol.ErrorInvalidMsg);\n  } else {\n    msgHandler.call(s, msg, payload);\n  }\n};\n\nmsgHandlers[protocol.MsgTypeSingleReq] = function (msg, payload) {\n  var s = this, handler, result;\n  handler = s.handlers.findRequestHandler(msg.name);\n\n  result = function (outbuf) {\n    s.sendMsg(protocol.MsgTypeSingleRes, msg.id, null, 0, outbuf);\n  };\n  result.error = function (err) {\n    var errstr = err.message || String(err);\n    s.sendMsg(protocol.MsgTypeErrorRes, msg.id, null, 0, errstr);\n  };\n\n  if (typeof handler !== 'function') {\n    result.error('no such operation \"'+msg.name+'\"');\n  } else {\n    try {\n      handler(payload, result, msg.name);\n    } catch (err) {\n      if (typeof console !== 'undefined') { console.error(err.stack || err); }\n      result.error('internal error');\n    }\n  }\n};\n\nfunction handleRes(msg, payload) {\n  var id = typeof msg.id === 'string' ? msg.id : msg.id.toString();\n  var s = this, callback = s.pendingRes[id];\n  if (msg.t !== protocol.MsgTypeStreamRes || !payload || (payload.length || payload.size) === 0) {\n    delete s.pendingRes[id];\n    if (s.pendingClose && !s.hasPendingRes) {\n      s.end();\n    }\n  }\n  if (typeof callback !== 'function') {\n    return; // ignore message\n  }\n  if (msg.t === protocol.MsgTypeErrorRes) {\n    callback(new Error(String(payload)), null);\n  } else {\n    callback(null, payload);\n  }\n}\n\nmsgHandlers[protocol.MsgTypeSingleRes] = handleRes;\nmsgHandlers[protocol.MsgTypeStreamRes] = handleRes;\nmsgHandlers[protocol.MsgTypeErrorRes] = handleRes;\n\nmsgHandlers[protocol.MsgTypeNotification] = function (msg, payload) {\n  var handler = this.handlers.findNotificationHandler(msg.name);\n  if (handler) {\n    handler(payload, msg.name);\n  }\n};\n\nmsgHandlers[protocol.MsgTypeHeartbeat] = function (msg) {\n  this.emit('heartbeat', {time:new Date(msg.size * 1000), load:msg.wait});\n};\n\n// ===============================================================================================\n// Sending messages\n\n\nSock.prototype.sendMsg = function(t, id, name, wait, payload) {\n  var payloadSize = (payload && typeof payload === 'string' && this.protocol === protocol.binary) ?\n    utf8.sizeOf(payload) :\n    payload ? payload.length || payload.size :\n    0;\n  var s = this, buf = s.protocol.makeMsg(t, id, name, wait, payloadSize);\n  // console.log('sendMsg(',t,id,name,payload,'): protocol.makeMsg =>',\n  //   typeof buf === 'string' ? buf : buf.toString());\n  try {\n    s.ws.send(buf);\n    if (payloadSize !== 0) {\n      s.ws.send(payload);\n    }\n  } catch (err) {\n    if (!this.ws || this.ws.readyState > WebSocket.OPEN) {\n      err = new Error('socket is closed');\n    }\n    throw err;\n  }\n};\n\n\nSock.prototype.closeError = function(code) {\n  var s = this, buf;\n  if (s.ws) {\n    try {\n      s.ws.send(s.protocol.makeMsg(protocol.MsgTypeProtocolError, null, null, 0, code));\n    } catch (e) {}\n    s.ws.close(4000 + code);\n  }\n};\n\nvar zeroes = '0000';\n\n// callback function(Error, outbuf)\nSock.prototype.bufferRequest = function(op, buf, callback) {\n  var s = this, id = s.nextOpID++;\n  if (s.nextOpID === 1679616) {\n    // limit for base36 within 4 digits (36^4=1679616)\n    s.nextOpID = 0;\n  }\n  id = id.toString(36);\n  id = zeroes.substr(0, 4 - id.length) + id;\n\n  s.pendingRes[id] = callback;\n  try {\n    s.sendMsg(protocol.MsgTypeSingleReq, id, op, 0, buf);\n  } catch (err) {\n    delete s.pendingRes[id];\n    callback(err);\n  }\n}\n\n\nSock.prototype.bufferNotify = function(name, buf) {\n  this.sendMsg(protocol.MsgTypeNotification, null, name, 0, buf);\n}\n\n\nSock.prototype.request = function(op, value, callback) {\n  var buf;\n  if (!callback) {\n    // no value\n    callback = value;\n  } else {\n    buf = JSON.stringify(value);\n  }\n  return this.bufferRequest(op, buf, function (err, buf) {\n    var value = decodeJSON(buf);\n    return callback(err, value);\n  });\n};\n\n\nSock.prototype.notify = function(op, value) {\n  var buf = JSON.stringify(value);\n  return this.bufferNotify(op, buf);\n};\n\n\n// ===============================================================================================\n\n// Represents a stream request.\n// Response(s) arrive by the \"data\"(buf) event. When the response is complete, a \"end\"(error)\n// event is emitted, where error is non-empty if the request failed.\nvar StreamRequest = function(s, op, id) {\n  return Object.create(StreamRequest.prototype, {\n    s:  {value:s},\n    op: {value:op, enumerable:true},\n    id: {value:id, enumerable:true},\n  });\n};\n\nEventEmitter.mixin(StreamRequest.prototype);\n\nStreamRequest.prototype.write = function (buf) {\n  if (!this.ended) {\n    if (!this.started) {\n      this.started = true;\n      this.s.sendMsg(protocol.MsgTypeStreamReq, this.id, this.op, 0, buf);\n    } else {\n      this.s.sendMsg(protocol.MsgTypeStreamReqPart, this.id, null, 0, buf);\n    }\n    if (!buf || buf.length === 0 || buf.size === 0) {\n      this.ended = true;\n    }\n  }\n};\n\n// Finalize the request\nStreamRequest.prototype.end = function () {\n  this.write(null);\n};\n\nSock.prototype.streamRequest = function(op) {\n  var s = this, id = s.nextStreamID++;\n  if (s.nextStreamID === 46656) {\n    // limit for base36 within 3 digits (36^3=46656)\n    s.nextStreamID = 0;\n  }\n  id = id.toString(36);\n  id = '!' + zeroes.substr(0, 3 - id.length) + id;\n\n  var req = StreamRequest(s, op, id);\n\n  s.pendingRes[id] = function (err, buf) {\n    if (err) {\n      req.emit('end', err);\n    } else if (!buf || buf.length === 0) {\n      req.emit('end', null);\n    } else {\n      req.emit('data', buf);\n    }\n  };\n\n  return req;\n};\n\n\n// ===============================================================================================\n\nfunction Handlers() { return Object.create(Handlers.prototype, {\n  reqHandlers:         {value:{}},\n  reqFallbackHandler:  {value:null, writable:true},\n  noteHandlers:        {value:{}},\n  noteFallbackHandler: {value:null, writable:true}\n}); }\nexports.Handlers = Handlers;\n\n\nHandlers.prototype.handleBufferRequest = function(op, handler) {\n  if (!op) {\n    this.reqFallbackHandler = handler;\n  } else {\n    this.reqHandlers[op] = handler;\n  }\n};\n\nHandlers.prototype.handleRequest = function(op, handler) {\n  return this.handleBufferRequest(op, function (buf, result, op) {\n    var resultWrapper = function(value) {\n      return result(JSON.stringify(value));\n    };\n    resultWrapper.error = result.error;\n    var value = decodeJSON(buf);\n    handler(value, resultWrapper, op);\n  });\n};\n\nHandlers.prototype.handleBufferNotification = function(name, handler) {\n  if (!name) {\n    this.noteFallbackHandler = handler;\n  } else {\n    this.noteHandlers[name] = handler;\n  }\n};\n\nHandlers.prototype.handleNotification = function(name, handler) {\n  this.handleBufferNotification(name, function (buf, name) {\n    handler(decodeJSON(buf), name);\n  });\n};\n\nHandlers.prototype.findRequestHandler = function(op) {\n  var handler = this.reqHandlers[op];\n  return handler || this.reqFallbackHandler;\n};\n\nHandlers.prototype.findNotificationHandler = function(name) {\n  var handler = this.noteHandlers[name];\n  return handler || this.noteFallbackHandler;\n};\n\n// TODO: Implement support for handling stream requests\n\n// ===============================================================================================\n\nfunction openWebSocket(s, addr, callback) {\n  var ws;\n  try {\n    ws = new WebSocket(addr);\n    ws.binaryType = 'arraybuffer';\n    ws.onclose = function (ev) {\n      var err = new Error('connection failed');\n      if (callback) callback(err);\n    };\n    ws.onopen = function(ev) {\n      ws.onerror = undefined;\n      s.adoptWebSocket(ws);\n      s.handshake();\n      if (callback) callback(null, s);\n      s.emit('open');\n      s.startReading();\n    };\n    ws.onmessage = function(ev) {\n      if (!ws._bufferedMessages) ws._bufferedMessages = [];\n      ws._bufferedMessages.push(ev.data);\n    };\n  } catch (err) {\n    if (callback) callback(err);\n    s.emit('close', err);\n  }\n}\n\n\n// gotalk.defaultResponderAddress is defined if the responder has announced a default address\n// to which connect to.\nif (global.gotalkResponderAt !== undefined) {\n  var at = global.gotalkResponderAt;\n  if (at && at.ws) {\n    gotalk.defaultResponderAddress =\n      (document.location.protocol == 'https:' ? 'wss://' : 'ws://') +\n      document.location.host + at.ws;\n  }\n  delete global.gotalkResponderAt;\n}\n\n\nSock.prototype.open = function(addr, callback) {\n  var s = this;\n  if (!callback && typeof addr == 'function') {\n    callback = addr;\n    addr = null;\n  }\n\n  if (!addr) {\n    if (!gotalk.defaultResponderAddress) {\n      throw new Error('address not specified (responder has not announced any default address)')\n    }\n    addr = gotalk.defaultResponderAddress;\n  }\n\n  openWebSocket(s, addr, callback);\n  return s;\n};\n\n\n// Open a connection to a gotalk responder.\n// \n// open(addr string[, onConnect(Error, Sock)]) -> Sock\n//   Connect to gotalk responder at `addr`\n//\n// open([onConnect(Error, Sock)]) -> Sock\n//   Connect to default gotalk responder.\n//   Throws an error if `gotalk.defaultResponderAddress` isn't defined.\n//\ngotalk.open = function(addr, onConnect) {\n  return Sock(gotalk.defaultHandlers).open(addr, onConnect);\n};\n\n\n// If `addr` is not provided, `gotalk.defaultResponderAddress` is used instead.\nSock.prototype.openKeepAlive = function(addr) {\n  var s = this;\n  if (s.keepalive) {\n    s.keepalive.disable();\n  }\n  s.keepalive = keepalive(s, addr);\n  s.keepalive.enable();\n  return s;\n};\n\n\n// Returns a new Sock with a persistent connection to a gotalk responder.\n// The Connection is automatically kept alive (by reconnecting) until Sock.end() is called.\n// If `addr` is not provided, `gotalk.defaultResponderAddress` is used instead.\ngotalk.connection = function(addr) {\n  return Sock(gotalk.defaultHandlers).openKeepAlive(addr);\n};\n\n\ngotalk.defaultHandlers = Handlers();\n\ngotalk.handleBufferRequest = function(op, handler) {\n  return gotalk.defaultHandlers.handleBufferRequest(op, handler);\n};\n\ngotalk.handle = function(op, handler) {\n  return gotalk.defaultHandlers.handleRequest(op, handler);\n};\n\ngotalk.handleBufferNotification = function (name, handler) {\n  return gotalk.defaultHandlers.handleBufferNotification(name, handler);\n};\n\ngotalk.handleNotification = function (name, handler) {\n  return gotalk.defaultHandlers.handleNotification(name, handler);\n};\n\n};\n\n\n__mainapi = {exports:{}};\n__main(__mainapi);\n\nglobal.gotalk = __mainapi.exports;\n})(this);\n"]}